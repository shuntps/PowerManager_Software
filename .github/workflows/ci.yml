name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Restore dependencies
        run: dotnet restore src/PowerManager.slnx

      - name: Build solution
        run: dotnet build src/PowerManager.slnx -c Debug --no-restore

      - name: Run tests
        run: dotnet test src/PowerManager.slnx -c Debug --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: "**/TestResults/*.trx"

  validate-commits:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit messages
        shell: bash
        run: |
          commits=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}..HEAD)

          echo "Validating commits:"
          echo "$commits"
          echo ""

          invalid_commits=()

          while IFS= read -r commit; do
            if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?(!)?: ]]; then
              invalid_commits+=("$commit")
            fi
          done <<< "$commits"

          if [ ${#invalid_commits[@]} -gt 0 ]; then
            echo "❌ Invalid commit messages found:"
            printf '%s\n' "${invalid_commits[@]}"
            echo ""
            echo "Commits must follow Conventional Commits format:"
            echo "  <type>(<scope>): <description>"
            echo ""
            echo "Valid types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert"
            exit 1
          fi

          echo "✅ All commits follow Conventional Commits format"
